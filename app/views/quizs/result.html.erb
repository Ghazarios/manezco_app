<% content_for :head do %>
  <%= javascript_include_tag "https://www.thomasfrank.se/sessvars.js" %>
<% end %>

<div class='container'>
    <div class="col-12 animate-fade-in-1000 container">

    <h1><%=@header%> Results</h1>
    
    <div class="card card-default inspectable container">
        <h3>You got: <span id="mark"></span> out of <%=@question.length%></h3>
        <% @question.each_with_index do |entry, index| %>
            <div>
                <h6>Question <%=index+=1%></h6>
                <p><%=entry[1]%></p>
                Your answer: <span id="user_answer_<%=index%>"></span>
                <p id="correct_answer_<%=index%>"></p>
            </div>
        <% end %>
        <a id='redo_test' href="/science/physics/sound">Redo Test</a>
    </div>
    </div>
</div>
<script>
  var wrong_answer = [];

  if (Array.prototype.equals) {
    console.warn('Overriding existing Array.prototype.equals. Possible causes: New API defines the method, there\'s a framework conflict or you\'ve got double inclusions in your code.');
  }

  Array.prototype.equals = function(array) {
    var foo, i, j, l;
    foo = true;
    if (!array) {
      foo = false;
    }
    if (this.length !== array.length) {
      foo = false;
    }
    i = 0;
    l = this.length;
    while (i < l) {
      if (this[i] instanceof Array && array[i] instanceof Array) {
        j = 0;
        if (this[i].length !== array[i].length) {
          wrong_answer.push(i + 1);
          $('#user_answer_' + (i + 1)).text(array[i]);
          $('#user_answer_' + (i + 1)).append(" <span class='incorrect'>Unlucky!</span>");
          foo = false;
        } else {
          while (j < this[i].length) {
            if (this[i][j] !== array[i][j]) {
              if (jQuery.inArray(i + 1, "wrong_answer")) {
                wrong_answer.push(i + 1);
              }
              foo = false;
              $('#user_answer_' + (i + 1)).text(array[i]);
              $('#user_answer_' + (i + 1)).append(" <span class='incorrect'>Unlucky!</span>");
            } else {
              $('#user_answer_' + (i + 1)).text(array[i]);
              $('#user_answer_' + (i + 1)).append(" <span class='correct'>Correct!</span>");
            }
            j++;
          }
        }
      } else if (this[i] !== array[i]) {
        $('#user_answer_' + (i + 1)).text(array[i]);
        $('#user_answer_' + (i + 1)).append(" <span class='incorrect'>Unlucky!</span>");
        wrong_answer.push(i + 1);
        foo = false;
      } else {
        $('#user_answer_' + (i + 1)).text(array[i]);
        $('#user_answer_' + (i + 1)).append(" <span class='correct'>Correct!</span>");
      }
      i++;
    }
    return foo;
  };

  Object.defineProperty(Array.prototype, 'equals', {
    enumerable: false
  });
  
  var i;
  if (sessvars.myObj) {
    console.log(sessvars.Answer.correctAnswer);
    sessvars.Answer.correctAnswer.equals(sessvars.myObj.userAnswer)
    i = 0;
    while (i < sessvars.Answer.correctAnswer.length) {
      if ($("#user_answer_" + (i + 1)).text().indexOf('Unlucky!') > -1) {
        $('#correct_answer_' + (i + 1)).text("Correct Answer: " + sessvars.Answer.correctAnswer[i]);
      }
      i++;
    }
  }
  
  var mark; //Simplify by using the correct answer counter
  if ($("#mark").length) {
    mark = $("div.card").html().match(/correct!/gi).length;
    $("#mark").text(mark);
  }

  $('#redo_test').click(function() {
    console.log("Clearing memory");
    sessvars.$.clearMem();
  });
</script>